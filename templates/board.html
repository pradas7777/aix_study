{% extends "base.html" %}

{% block title %}{{ board_title }} - AI+X ì‹ ë¦¼ í™”ì´íŒ… {% endblock %}

{% block content %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<h2>{{ board_title }}</h2>

<div class="card" style="background: #f0f7ff;">
    <div class="card" style="background: #f0f7ff;"></div>
    <h3>ìƒˆ ê¸€ ì“°ê¸° </h3>
    
    <form action="/post/create" method="post" enctype="multipart/form-data" id="postForm">
        <input type="hidden" name="type" value="{{ post_type }}">
        <div><input type="text" name="title" placeholder="ì œëª©" required></div>
        
        <div id="drop-zone" style="border: 2px dashed #3498db; padding: 20px; text-align: center; background: #fff; cursor: pointer;">
            íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš” (ìµœëŒ€ 5ì¥, ë³¸ë¬¸ ì²¨ë¶€ì‹œ ì•„ë˜ ì´ë¯¸ì§€ ì•„ì´ì½˜ í´ë¦­!)
            <input type="file" name="images" id="file-input" multiple accept="image/*" style="display: none;">
        </div>
        <div id="preview-container" style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;"></div>

        <div id="editor" style="min-height: 200px; height: auto; background: white; margin-top: 10px;"></div>
        <div style="margin-top: 20px;"></div>
        <label for="file-upload" style="font-weight: bold;">ğŸ“ íŒŒì¼ ì²¨ë¶€:</label>
        <input type="file" id="file-upload" name="file" style="margin-left: 10px;">
        <p style="font-size: 14px; color: #666;">(ë¬¸ì„œ, ì••ì¶•íŒŒì¼ ë“±ì„ ììœ ë¡­ê²Œ ì˜¬ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)</p>
        <input type="hidden" name="content" id="content">
        <button type="submit" class="btn" style="margin-top: 10px;">ì˜¬ë¦¬ê¸°</button>
    </form>

</div>
<script> 
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const previewContainer = document.getElementById('preview-container');

    dropZone.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', handleFiles);
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.background = '#e1f0fa'; });
    dropZone.addEventListener('dragleave', () => dropZone.style.background = '#fff');
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        fileInput.files = e.dataTransfer.files;
        handleFiles();
    });

    function handleFiles() {
        previewContainer.innerHTML = '';
        const files = Array.from(fileInput.files).slice(0, 5); // 5ì¥ ì œí•œ
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.width = '80px';
                img.style.height = '80px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '5px';
                previewContainer.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    }
</script>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    var quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš©',
        modules: {
            toolbar: {
                container: [
                [{ 'header': [1, 2, 3, false] }], // ì œëª© í¬ê¸° ì„¤ì •
                ['bold', 'italic', 'underline', 'strike'], // êµµê²Œ, ê¸°ìš¸ì„ ë“±
                [{ 'color': [] }, { 'background': [] }], //  ìƒ‰ìƒ ë° ë°°ê²½ìƒ‰ ì¶”ê°€!
                ['image', 'link'], // ì´ë¯¸ì§€ ì‚½ì… ë²„íŠ¼ ì¶”ê°€!
                ['clean'] // ì„œì‹ ì§€ìš°ê¸°
            ],
            handlers: {
                image: imageHandler // ì´ë¯¸ì§€ë¥¼ í´ë¦­í–ˆì„ ë•Œ ì‹¤í–‰í•  í•¨ìˆ˜ ì—°ê²°
            }
        }
    }
});

// ì´ë¯¸ì§€ë¥¼ ì„œë²„ë¡œ ì „ì†¡í•˜ëŠ” í•¨ìˆ˜
function imageHandler() {
    const input = document.createElement('input');
    input.setAttribute('type', 'file');
    input.setAttribute('accept', 'image/*');
    input.click();

    input.onchange = async () => {
        const file = input.files[0];
        const formData = new FormData();
        formData.append('file', file);

        // ì•„ê¹Œ ë§Œë“  Python APIë¡œ ì´ë¯¸ì§€ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.
        const res = await fetch('/post/image/upload', {
            method: 'POST',
            body: formData
        });
        const data = await res.json();
        
        // ì—ë””í„°ì˜ í˜„ì¬ ì»¤ì„œ ìœ„ì¹˜ì— ì´ë¯¸ì§€ ì£¼ì†Œë¥¼ ì‚½ì…í•©ë‹ˆë‹¤.
        const range = quill.getSelection();
        quill.insertEmbed(range.index, 'image', data.url);
    };
}

    // í¼ ì œì¶œ ì‹œ ì—ë””í„° ë‚´ìš©ì„ ìˆ¨ê²¨ì§„ inputì— ë‹´ì•„ì¤ë‹ˆë‹¤.
    var form = document.getElementById('postForm');
    form.onsubmit = function() {
        var content = document.querySelector('input[name=content]');
        content.value = quill.root.innerHTML;
    };
</script>
{% endblock %}
