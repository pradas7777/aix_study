{% extends "base.html" %}

{% block title %}{{ board_title }} - AI+X 신림 화이팅 {% endblock %}

{% block content %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<h2>{{ board_title }}</h2>

<div class="card" style="background: #f0f7ff;">
    <div class="card" style="background: #f0f7ff;">
    <h3>새 글 쓰기 </h3>
    <form action="/post/create" method="post" enctype="multipart/form-data" id="postForm">
        <input type="hidden" name="type" value="{{ post_type }}">
        <div><input type="text" name="title" placeholder="제목" required></div>
        
        <div id="drop-zone" style="border: 2px dashed #3498db; padding: 20px; text-align: center; background: #fff; cursor: pointer;">
            파일을 드래그하거나 클릭하여 이미지를 선택하세요 (최대 5장, 본문 첨부시 아래 이미지 아이콘 클릭!)
            <input type="file" name="images" id="file-input" multiple accept="image/*" style="display: none;">
        </div>
        <div id="preview-container" style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;"></div>

        <div id="editor" style="height: 200px; background: white; margin-top: 10px;"></div>
        <input type="hidden" name="content" id="content">
        <button type="submit" class="btn" style="margin-top: 10px;">올리기</button>
    </form>
</div>
<script> 
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const previewContainer = document.getElementById('preview-container');

    dropZone.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', handleFiles);
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.background = '#e1f0fa'; });
    dropZone.addEventListener('dragleave', () => dropZone.style.background = '#fff');
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        fileInput.files = e.dataTransfer.files;
        handleFiles();
    });

    function handleFiles() {
        previewContainer.innerHTML = '';
        const files = Array.from(fileInput.files).slice(0, 5); // 5장 제한
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.width = '80px';
                img.style.height = '80px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '5px';
                previewContainer.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    }
</script>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    var quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: '내용을 입력하세용',
        modules: {
            toolbar: {
                container: [
                [{ 'header': [1, 2, 3, false] }], // 제목 크기 설정
                ['bold', 'italic', 'underline', 'strike'], // 굵게, 기울임 등
                [{ 'color': [] }, { 'background': [] }], // ⭐ 색상 및 배경색 추가!
                ['image', 'link'], // ⭐ 이미지 삽입 버튼 추가!
                ['clean'] // 서식 지우기
            ],
            handlers: {
                image: imageHandler // 이미지를 클릭했을 때 실행할 함수 연결
            }
        }
    }
});

// 이미지를 서버로 전송하는 함수
function imageHandler() {
    const input = document.createElement('input');
    input.setAttribute('type', 'file');
    input.setAttribute('accept', 'image/*');
    input.click();

    input.onchange = async () => {
        const file = input.files[0];
        const formData = new FormData();
        formData.append('file', file);

        // 아까 만든 Python API로 이미지를 보냅니다.
        const res = await fetch('/post/image/upload', {
            method: 'POST',
            body: formData
        });
        const data = await res.json();
        
        // 에디터의 현재 커서 위치에 이미지 주소를 삽입합니다.
        const range = quill.getSelection();
        quill.insertEmbed(range.index, 'image', data.url);
    };
}

    // 폼 제출 시 에디터 내용을 숨겨진 input에 담아줍니다.
    var form = document.getElementById('postForm');
    form.onsubmit = function() {
        var content = document.querySelector('input[name=content]');
        content.value = quill.root.innerHTML;
    };
</script>
{% endblock %}
